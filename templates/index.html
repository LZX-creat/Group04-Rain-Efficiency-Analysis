<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>é›¨æ°´åˆ©ç”¨ç®¡ç†ç³»ç»Ÿ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<style>
    :root { --sidebar-width: 240px; }

    /* æ ¸å¿ƒä¿®å¤ï¼šé˜²æ­¢å¼¹çª—å¯¼è‡´ body åç§» */
    body.swal2-shown { padding-right: 0 !important; }

    body { background: #f0f2f5; display: flex; height: 100vh; overflow: hidden; margin: 0; font-family: -apple-system, "Noto Sans SC", sans-serif; }

    /* ä¾§è¾¹æ å›ºå®šï¼Œå½»åº•éš”ç¦»å¼¹çª—å¹²æ‰° */
    .sidebar {
        width: var(--sidebar-width);
        background: #212529;
        color: white;
        flex-shrink: 0;
        position: fixed;
        height: 100vh;
        z-index: 1000;
    }

    .sidebar-header { padding: 20px; font-size: 1.1rem; background: #1a202c; font-weight: bold; }
    .nav-link { color: #adb5bd; padding: 15px 20px; text-decoration: none; display: block; border-left: 4px solid transparent; }
    .nav-link.active, .nav-link:hover { background: #2d3748; color: white; border-left-color: #3182ce; }

    /* ä¸»å®¹å™¨åç§»å‡ºä¾§è¾¹æ å®½åº¦ */
    .main-container {
        flex: 1;
        margin-left: var(--sidebar-width);
        overflow-y: auto;
        padding: 24px 32px;
    }

    .section-card { background: #fff; border-radius: 12px; box-shadow: 0 2px 12px rgba(0,0,0,0.04); margin-bottom: 24px; padding: 20px; }
    .section-title { font-size: 0.95rem; font-weight: 800; color: #4a5568; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
    .table-container { background: #fff; border-radius: 12px; border: 1px solid #edf2f7; padding: 10px; }
    .rate-tag { padding: 4px 12px; border-radius: 50px; font-size: 0.8rem; background: #ebf8ff; color: #2b6cb0; border: 1px solid #90cdf4; font-weight: bold; }
    .btn-group-action .btn { width: 32px; height: 32px; padding: 0; border-radius: 8px; margin: 0 2px; }
</style>
</head>
<body>

<div class="sidebar">
    <div class="sidebar-header">ğŸŒ§ï¸ é›¨æ°´åˆ©ç”¨ç®¡ç†</div>
    <nav class="mt-3">
        <a href="/" class="nav-link active">ğŸ“ é™é›¨é‡å°è´¦</a>
        <a href="/stats" class="nav-link">ğŸ“Š ç»Ÿè®¡ä¸­å¿ƒ</a>
        <a href="/import_page" class="nav-link">ğŸ“¤ ä¸Šä¼ ä¸­å¿ƒ</a>
        <a href="/settings" class="nav-link">âš™ï¸ åå°è®¾ç½®</a>
        <a href="javascript:void(0)" onclick="confirmLogout()" class="nav-link text-warning"><i class="bi bi-box-arrow-right"></i> é€€å‡ºç™»å½•</a>
    </nav>
</div>

<div class="main-container">
    <div class="section-card">
        <div class="section-title"><i class="bi bi-plus-circle"></i> å¿«é€Ÿå½•å…¥</div>
        <form id="addForm" class="row g-3">
            <div class="col-md-2"><input type="number" name="year" class="form-control" placeholder="å¹´ä»½" required></div>
            <div class="col-md-2"><input type="number" step="0.1" name="total" class="form-control" placeholder="é™é›¨(mm)" required></div>
            <div class="col-md-2"><input type="number" step="0.1" name="overflow" class="form-control" placeholder="æº¢æµ(mm)" required></div>
            <div class="col-md-2"><input type="number" step="0.1" name="car_wash" class="form-control" placeholder="æ´—è½¦(mÂ³)"></div>
            <div class="col-md-2"><input type="number" step="0.1" name="irrigation" class="form-control" placeholder="æµ‡çŒ(mÂ³)"></div>
            <div class="col-md-2"><button type="submit" class="btn btn-primary w-100">ä¿å­˜</button></div>
        </form>
    </div>

    <div class="section-card">
        <div class="section-title"><i class="bi bi-filter"></i> æ™ºèƒ½ç­›é€‰</div>
        <div class="row g-3">
            <div class="col-md-2"><input type="number" id="searchYear" class="form-control" placeholder="å¹´ä»½"></div>
            <div class="col-md-6">
                <div class="input-group">
                    <span class="input-group-text bg-white">é™é›¨èŒƒå›´</span>
                    <input type="number" id="rainMin" class="form-control" placeholder="æœ€å°">
                    <input type="number" id="rainMax" class="form-control" placeholder="æœ€å¤§">
                </div>
            </div>
            <div class="col-md-2"><button class="btn btn-dark w-100" onclick="loadData(1)">æœç´¢</button></div>
            <div class="col-md-2"><button class="btn btn-outline-secondary w-100" onclick="resetSearch()">é‡ç½®</button></div>
        </div>
    </div>

    <div class="table-container">
        <table class="table table-hover">
            <thead>
                <tr>
                    <th>å¹´ä»½</th><th>æ€»é™é›¨ (mm)</th><th>æº¢æµé‡ (mm)</th><th>åˆ©ç”¨é‡ (mÂ³)</th><th>æˆªç•™ç‡</th><th class="text-center">æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
        <div class="d-flex justify-content-between align-items-center mt-3 p-2">
            <div id="pageInfo" class="small text-muted"></div>
            <nav><ul class="pagination pagination-sm mb-0" id="pagination"></ul></nav>
        </div>
    </div>
</div>

<div class="modal fade" id="viewModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header"><h5>æ•°æ®è¯¦æƒ…</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body" id="viewBody"></div>
        </div>
    </div>
</div>

<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog">
        <form id="editForm" class="modal-content">
            <input type="hidden" name="id" id="editId">
            <div class="modal-header"><h5>ç¼–è¾‘è®°å½•</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body row g-3">
                <div class="col-12"><label>æ€»é™é›¨ (mm)</label><input type="number" step="0.1" name="total" id="editTotal" class="form-control" required></div>
                <div class="col-12"><label>æº¢æµé‡ (mm)</label><input type="number" step="0.1" name="overflow" id="editOverflow" class="form-control" required></div>
                <div class="col-6"><label>æ´—è½¦ (mÂ³)</label><input type="number" step="0.1" name="car_wash" id="editCar" class="form-control"></div>
                <div class="col-6"><label>çŒæº‰ (mÂ³)</label><input type="number" step="0.1" name="irrigation" id="editIrr" class="form-control"></div>
            </div>
            <div class="modal-footer"><button type="submit" class="btn btn-primary">æ›´æ–°</button></div>
        </form>
    </div>
</div>

<script>
    let currentPage = 1;
    const pageSize = 5;
    let recordsCache = [];

    async function loadData(page = 1) {
        currentPage = page;
        const year = document.getElementById('searchYear').value || '';
        const min = document.getElementById('rainMin').value || '';
        const max = document.getElementById('rainMax').value || '';
        const url = `/api/data?year=${year}&min=${min}&max=${max}`;

        try {
            const res = await fetch(url);
            const data = await res.json();
            recordsCache = data.records;
            renderTable(data.records);
            renderPagination(data.total, page);
            document.getElementById('pageInfo').innerText = `æ‰¾åˆ° ${data.total} æ¡è®°å½•`;
        } catch (err) {
            console.error("åŠ è½½å¤±è´¥:", err);
        }
    }

    async function confirmLogout() {
    const result = await Swal.fire({
        title: 'ç¡®å®šè¦é€€å‡ºç³»ç»Ÿå—ï¼Ÿ',
        text: "é€€å‡ºåéœ€è¦é‡æ–°ç™»å½•æ‰èƒ½æŸ¥çœ‹æ•°æ®",
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#3182ce',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'ç¡®å®šé€€å‡º',
        cancelButtonText: 'å–æ¶ˆ',
        heightAuto: false,     // é˜²æ­¢é¡µé¢è·³åŠ¨
        scrollbarPadding: false // é˜²æ­¢èœå•ä½ç§»
    });

    if (result.isConfirmed) {
        window.location.href = '/logout_page';
    }
}

    function renderTable(data) {
        const body = document.getElementById('tableBody');
        if (!data || data.length === 0) {
            body.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-muted">æœªæ‰¾åˆ°ç›¸å…³æ•°æ®</td></tr>';
            return;
        }
        body.innerHTML = data.map(r => `
            <tr>
                <td class="fw-bold">${r.year}</td>
                <td>${r.total}</td>
                <td class="text-danger">${r.overflow}</td>
                <td>${(r.car_wash + r.irrigation).toFixed(1)}</td>
                <td><span class="rate-tag">${r.rate_str}</span></td>
                <td class="text-center">
                    <div class="btn-group-action">
                        <button class="btn btn-outline-success btn-sm" onclick="viewDetail(${r.id})"><i class="bi bi-eye"></i></button>
                        <button class="btn btn-outline-primary btn-sm" onclick="openEdit(${r.id})"><i class="bi bi-pencil"></i></button>
                        <button class="btn btn-outline-danger btn-sm" onclick="deleteRecord(${r.id})"><i class="bi bi-trash"></i></button>
                    </div>
                </td>
            </tr>
        `).join('');
    }

    function resetSearch() {
        document.getElementById('searchYear').value = '';
        document.getElementById('rainMin').value = '';
        document.getElementById('rainMax').value = '';
        loadData(1);
    }

    function viewDetail(id) {
        const r = recordsCache.find(x => x.id === id);
        document.getElementById('viewBody').innerHTML = `
            <ul class="list-group">
                <li class="list-group-item">å¹´ä»½: ${r.year}</li>
                <li class="list-group-item">æ€»é™é›¨: ${r.total} mm</li>
                <li class="list-group-item">æº¢æµé‡: ${r.overflow} mm</li>
                <li class="list-group-item">åˆ©ç”¨ç‡: ${r.rate_str}</li>
            </ul>`;
        new bootstrap.Modal('#viewModal').show();
    }

    function openEdit(id) {
        const r = recordsCache.find(x => x.id === id);
        document.getElementById('editId').value = r.id;
        document.getElementById('editTotal').value = r.total;
        document.getElementById('editOverflow').value = r.overflow;
        document.getElementById('editCar').value = r.car_wash;
        document.getElementById('editIrr').value = r.irrigation;
        new bootstrap.Modal('#editModal').show();
    }

    // ç¼–è¾‘æ›´æ–°é€»è¾‘ï¼šå¢åŠ æˆåŠŸæç¤º
    document.getElementById('editForm').onsubmit = async (e) => {
        e.preventDefault();
        try {
            await fetch(`/api/edit/${document.getElementById('editId').value}`, {method:'POST', body: new FormData(e.target)});
            bootstrap.Modal.getInstance('#editModal').hide();

            Swal.fire({
                title: 'ä¿®æ”¹æˆåŠŸ',
                icon: 'success',
                timer: 1000,
                showConfirmButton: false,
                heightAuto: false,
                scrollbarPadding: false
            });

            loadData(currentPage);
        } catch (err) {
            Swal.fire('å¤±è´¥', 'æ›´æ–°æ•°æ®æ—¶å‘ç”Ÿé”™è¯¯', 'error');
        }
    };

    // åˆ é™¤æç¤ºï¼šSweetAlert2
    async function deleteRecord(id) {
        const result = await Swal.fire({
            title: 'ç¡®å®šè¦åˆ é™¤å—ï¼Ÿ',
            text: "åˆ é™¤åè®°å½•å°†æ°¸ä¹…ç§»é™¤ï¼",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'ç¡®å®šåˆ é™¤',
            cancelButtonText: 'å–æ¶ˆ',
            heightAuto: false,
            scrollbarPadding: false
        });

        if (result.isConfirmed) {
            try {
                await fetch(`/api/delete/${id}`, {method:'POST'});
                Swal.fire({
                    title: 'å·²åˆ é™¤',
                    icon: 'success',
                    timer: 1000,
                    showConfirmButton: false,
                    heightAuto: false,
                    scrollbarPadding: false
                });
                loadData(1);
            } catch (err) {
                Swal.fire('å¤±è´¥', 'åˆ é™¤å¤±è´¥', 'error');
            }
        }
    }

    // å¿«é€Ÿå½•å…¥ï¼šå¢åŠ æˆåŠŸæç¤º
    document.getElementById('addForm').onsubmit = async (e) => {
        e.preventDefault();
        try {
            await fetch('/api/add', {method:'POST', body: new FormData(e.target)});
            e.target.reset();

            Swal.fire({
                title: 'ä¿å­˜æˆåŠŸ',
                icon: 'success',
                timer: 1000,
                showConfirmButton: false,
                heightAuto: false,
                scrollbarPadding: false
            });

            loadData(1);
        } catch (err) {
            Swal.fire('å¤±è´¥', 'ä¿å­˜å¤±è´¥', 'error');
        }
    };

    function renderPagination(total, current) {
        const pages = Math.ceil(total / pageSize) || 1;
        let html = '';
        for(let i=1; i<=pages; i++) {
            html += `<li class="page-item ${i===current?'active':''}"><a class="page-link" href="javascript:void(0)" onclick="loadData(${i})">${i}</a></li>`;
        }
        document.getElementById('pagination').innerHTML = html;
    }

    window.onload = () => loadData(1);
</script>
</body>
</html>